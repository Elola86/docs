
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.3">
    
    
      
        <title>JITP (Just In Time Provisioning) - Lamassu IoT Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4a0965b7.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/scheme.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="lamassu" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#jitp-just-in-time-provisioning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Lamassu IoT Docs" class="md-header__button md-logo" aria-label="Lamassu IoT Docs" data-md-component="logo">
      
  <img src="../img/lamassu.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lamassu IoT Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              JITP (Just In Time Provisioning)
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="lamassu" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Lamassu IoT Docs" class="md-nav__button md-logo" aria-label="Lamassu IoT Docs" data-md-component="logo">
      
  <img src="../img/lamassu.svg" alt="logo">

    </a>
    Lamassu IoT Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to Lamassu Iot Docs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        Install Lamassu Compose
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../protocols/" class="md-nav__link">
        Protocols
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../manage/" class="md-nav__link">
        Managing Lamassu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../extension/" class="md-nav__link">
        Extending Lamassu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../aws/" class="md-nav__link">
        AWS Services used by Lamassu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        Azure Services used by Lamassu
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          JITP (Just In Time Provisioning)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        JITP (Just In Time Provisioning)
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flow" class="md-nav__link">
    Flow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detailed-jitpd" class="md-nav__link">
    Detailed JITPD
  </a>
  
    <nav class="md-nav" aria-label="Detailed JITPD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-ca-in-aws-iot-core" class="md-nav__link">
    Step 1: Create CA in AWS Iot Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-create-jitp-role" class="md-nav__link">
    Step 2: Create JITP Role
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-attach-a-jitp-template-to-ca-on-iot-core" class="md-nav__link">
    Step 3: Attach a JITP template to CA on IoT Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-issue-a-device-certificate-with-that-ca" class="md-nav__link">
    Step 4: Issue a device certificate with that CA.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-load-the-certificate-in-the-device" class="md-nav__link">
    Step 5: Load the certificate in the device
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-connect-to-the-iot-core-enpoint-using-that-certificate" class="md-nav__link">
    Step 6: Connect to the IoT Core Enpoint using that certificate.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../virtualDMS/" class="md-nav__link">
        Lamassu Virtual DMS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../virtualDevice/" class="md-nav__link">
        Lamassu Virtual Device
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pkcs/" class="md-nav__link">
        PKCS 11
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flow" class="md-nav__link">
    Flow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detailed-jitpd" class="md-nav__link">
    Detailed JITPD
  </a>
  
    <nav class="md-nav" aria-label="Detailed JITPD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-ca-in-aws-iot-core" class="md-nav__link">
    Step 1: Create CA in AWS Iot Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-create-jitp-role" class="md-nav__link">
    Step 2: Create JITP Role
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-attach-a-jitp-template-to-ca-on-iot-core" class="md-nav__link">
    Step 3: Attach a JITP template to CA on IoT Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-issue-a-device-certificate-with-that-ca" class="md-nav__link">
    Step 4: Issue a device certificate with that CA.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-load-the-certificate-in-the-device" class="md-nav__link">
    Step 5: Load the certificate in the device
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-connect-to-the-iot-core-enpoint-using-that-certificate" class="md-nav__link">
    Step 6: Connect to the IoT Core Enpoint using that certificate.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="jitp-just-in-time-provisioning">JITP (Just In Time Provisioning)</h1>
<h2 id="overview">Overview</h2>
<p>You can have your devices provisioned when they first attempt to connect to AWS IoT with <strong><em>just-in-time provisioning (JITP)</em></strong>. To provision the device, you must enable automatic registration and associate a provisioning template with the CA certificate used to sign the device certificate.</p>
<p>When a device attempts to connect to AWS IoT by using a certificate signed by a registered CA certificate, AWS IoT loads the template from the CA certificate and uses it to register the thing. The JITP workflow first registers a certificate with a status value of PENDING_ACTIVATION. When the device provisioning flow is complete, the status of the certificate is changed to ACTIVE.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>To perform the tests, we need the following prerequisites:</p>
<ul>
<li>Install jq and mosquitto-clients
<div class="highlight"><pre><span></span><code>apt install jq
apt install mosquitto-clients
</code></pre></div></li>
<li>Configure AWS CLI: <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code> and <code>REGION</code> must be configured. <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">Configure AWS CLI</a></li>
</ul>
<h2 id="flow">Flow</h2>
<ol>
<li>Create a certificate authority and upload it to AWS.</li>
<li>Attach a JITP template to the CA in AWS IoT Core. </li>
<li>Enable auto-registration for that CA in AWS.</li>
<li>Issue a certificate with that CA.</li>
<li>Load the certificate in the device</li>
<li>Connect to the IoT Core Enpoint using that certificate.</li>
</ol>
<p>The device will automatically register in AWS IoT Core with the corresponding certificate and the certificate would be attached to the policy stated in the JITP template. Now the device can interact with AWS.</p>
<blockquote>
<p><img alt="⚠" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/26a0.svg" title=":warning:" /> <strong><em>NOTE</em></strong>* : Device fails to connect to AWS on first attempt. </p>
</blockquote>
<h2 id="usage">Usage</h2>
<p>Steps to reproduce:</p>
<ol>
<li>Create a CA certificate in AWS.
 <div class="highlight"><pre><span></span><code>bash jitp_demo.sh
</code></pre></div>
 Fill the following inputs and check that your CA has been correctly created in AWS IoT Core.</li>
</ol>
<div class="highlight"><pre><span></span><code>   Introduce CA name: 
   Introduce demo device name:
   Introduce AWS Policy Name <span class="o">(</span>Must be unique <span class="k">in</span> AWS<span class="o">)</span>:
</code></pre></div>
<p>This script covers steps 1 to 4 in JITP flow.</p>
<ol>
<li>As a result of <code>jitp_demo.sh</code> script some test certificates have been created under <code>test/certs</code> folder. You can execute <code>test/go/main.go</code> or <code>test/bash/mosquitto.sh</code> to test connection to AWS IoT Core.<blockquote>
<p><img alt="⚠" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/26a0.svg" title=":warning:" /> <strong>If you are using mosquitto.sh</strong>: you need to change -i flag to be equal to the certificate common name and -t flag (topic) must be "<strong>common_name</strong>/<em>" for the device to connect to AWS. For example, if CN=demodev:
<div class="highlight"><pre><span></span><code>mosquitto_pub --cafile ../certs/awsRootCA.pem  <span class="se">\</span>
            --cert ../certs/deviceCertAndCACert.crt <span class="se">\</span>
            --key ../certs/deviceCert.key <span class="se">\</span>
            -h a3hczhtwc7h4es-ats.iot.eu-west-1.amazonaws.com <span class="se">\</span>
            -p <span class="m">8883</span> -q <span class="m">1</span> <span class="se">\</span>
            -t demodev -i demodev -m <span class="s2">&quot;hello&quot;</span> -d 
</code></pre></div>
<img alt="⚠" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/26a0.svg" title=":warning:" /> </em><em>If you are using go main.go</em>*: you need to change device Id and topic. Lines 103 and 118.
<div class="highlight"><pre><span></span><code><span class="nx">opts</span><span class="p">.</span><span class="nx">SetClientID</span><span class="p">(</span><span class="s">&quot;demodev&quot;</span><span class="p">).</span><span class="nx">SetTLSConfig</span><span class="p">(</span><span class="nx">tlsconfig</span><span class="p">)</span><span class="w"></span>
<span class="o">...</span><span class="w"></span>
<span class="nx">c</span><span class="p">.</span><span class="nx">Publish</span><span class="p">(</span><span class="s">&quot;demodev/hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">)</span><span class="w"></span>
</code></pre></div></p>
</blockquote>
</li>
</ol>
<h2 id="detailed-jitpd">Detailed JITPD</h2>
<h3 id="step-1-create-ca-in-aws-iot-core">Step 1: Create CA in AWS Iot Core</h3>
<hr />
<p>AWS IoT Core requires to upload a verification certificate to be uploaded to register a CA certificate. A verification certificate is a certificate signed by that CA, this way we proof the CA we are uploading is ours.</p>
<p>First we have to create a test CA certificate using openssl. For that we create a test OpenSSL config file: 
<div class="highlight"><pre><span></span><code>mkdir openssl
touch openssl/deviceRootCA_openssl.conf
</code></pre></div>
deviceRootCA_openssl.conf:
<div class="highlight"><pre><span></span><code>tee openssl/deviceRootCA_openssl.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">[ req ]</span>
<span class="s">distinguished_name       = req_distinguished_name</span>
<span class="s">extensions               = v3_ca</span>
<span class="s">req_extensions           = v3_ca</span>

<span class="s">[ v3_ca ]</span>
<span class="s">basicConstraints         = CA:TRUE</span>

<span class="s">[ req_distinguished_name ]</span>
<span class="s">countryName              = Country Name (2 letter code)</span>
<span class="s">countryName_default      = IN</span>
<span class="s">countryName_min          = 2</span>
<span class="s">countryName_max          = 2</span>
<span class="s">organizationName         = Organization Name (eg, company)</span>
<span class="s">organizationName_default = AMZ</span>
<span class="s">EOF</span>
</code></pre></div></p>
<p>Now create a folder to store the certificates that will be issued:
<div class="highlight"><pre><span></span><code>mkdir -p test/certs
</code></pre></div>
Generate device CA private key:
<div class="highlight"><pre><span></span><code>openssl genrsa -out test/certs/deviceRootCA.key <span class="m">2048</span> 
<span class="sb">````</span>
Create CSR <span class="k">for</span> device root:

<span class="sb">```</span>bash
openssl req -new -sha256 -key test/certs/deviceRootCA.key -nodes -out test/certs/deviceRootCA.csr -config openssl/deviceRootCA_openssl.conf -subj <span class="s2">&quot;/C=ES/O=testCAName&quot;</span> 
</code></pre></div>
Creating CA certificate:
<div class="highlight"><pre><span></span><code>openssl x509 -req -days <span class="m">3650</span> -extfile openssl/deviceRootCA_openssl.conf -extensions v3_ca -in test/certs/deviceRootCA.csr -signkey test/certs/deviceRootCA.key -out test/certs/deviceRootCA.pem 
</code></pre></div></p>
<p>Getting CA registration code from your AWS region:
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">region</span><span class="o">=</span>&lt;your AWS region&gt;
<span class="nb">export</span> <span class="nv">reg_code</span><span class="o">=</span><span class="k">$(</span>aws iot get-registration-code --region <span class="nv">$region</span> <span class="p">|</span> jq -r .registrationCode<span class="k">)</span> 
</code></pre></div>
Generation private key for CA verification certificate:
<div class="highlight"><pre><span></span><code>openssl genrsa -out test/certs/verificationCert.key <span class="m">2048</span> 
</code></pre></div>
Generating CSR for CA verification certificate:
<div class="highlight"><pre><span></span><code>openssl req -new -key test/certs/verificationCert.key -out test/certs/verificationCert.csr -subj <span class="s2">&quot;/C=ES/ST=Gipuzkoa/L=Arrasate/O=testCAName/OU=Lamassu/CN=</span><span class="nv">$reg_code</span><span class="s2">&quot;</span>
</code></pre></div>
Generating CA verification certificate:
<div class="highlight"><pre><span></span><code>openssl x509 -req -in test/certs/verificationCert.csr -CA test/certs/deviceRootCA.pem -CAkey test/certs/deviceRootCA.key -CAcreateserial -out test/certs/verificationCert.crt -days <span class="m">500</span> -sha256 
</code></pre></div>
Once the CA certificate is created and the verification certificate is signed we can upload the CA to AWS IoT Core:
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">certificate_id</span><span class="o">=</span><span class="k">$(</span>aws iot register-ca-certificate --ca-certificate file://test/certs/deviceRootCA.pem  --verification-cert file://test/certs/verificationCert.crt --set-as- <span class="p">|</span> jq -r .certificateId<span class="k">)</span> 
</code></pre></div></p>
<h3 id="step-2-create-jitp-role">Step 2: Create JITP Role</h3>
<hr />
<p>To create service Role for JITP follow the following link: <a href="https://aws.amazon.com/es/blogs/iot/setting-up-just-in-time-provisioning-with-aws-iot-core/">JITP Role</a></p>
<h3 id="step-3-attach-a-jitp-template-to-ca-on-iot-core">Step 3: Attach a JITP template to CA on IoT Core</h3>
<hr />
<p>Attach the registration configuration file to the CA uploaded in the previous step.
First create a policy:
<div class="highlight"><pre><span></span><code>mkdir templates
touch templates/policy.json
</code></pre></div>
Export AWS account number
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">aws_account</span><span class="o">=</span>&lt;your account number&gt;
</code></pre></div>
templates/policy.json
<div class="highlight"><pre><span></span><code>tee templates/policy.json <span class="s">&lt;&lt;EOF</span>
<span class="s">{</span>
<span class="s">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
<span class="s">  &quot;Statement&quot;: [</span>
<span class="s">    {</span>
<span class="s">      &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="s">      &quot;Action&quot;: [</span>
<span class="s">        &quot;iot:Connect&quot;</span>
<span class="s">      ],</span>
<span class="s">      &quot;Resource&quot;: [</span>
<span class="s">        &quot;arn:aws:iot:eu-west-1:$aws_account:client/${iot:Connection.Thing.ThingName}&quot;</span>
<span class="s">      ]</span>
<span class="s">    },</span>
<span class="s">    {</span>
<span class="s">      &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="s">      &quot;Action&quot;: [</span>
<span class="s">        &quot;iot:Publish&quot;,</span>
<span class="s">        &quot;iot:Receive&quot;</span>
<span class="s">      ],</span>
<span class="s">      &quot;Resource&quot;: [</span>
<span class="s">        &quot;arn:aws:iot:eu-west-1:$aws_account:topic/${iot:Connection.Thing.ThingName}/*&quot;</span>
<span class="s">      ]</span>
<span class="s">    },</span>
<span class="s">    {</span>
<span class="s">      &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="s">      &quot;Action&quot;: [</span>
<span class="s">        &quot;iot:Subscribe&quot;</span>
<span class="s">      ],</span>
<span class="s">      &quot;Resource&quot;: [</span>
<span class="s">        &quot;arn:aws:iot:eu-west-1:$aws_account:topicfilter/${iot:Connection.Thing.ThingName}/*&quot;</span>
<span class="s">      ]</span>
<span class="s">    }</span>
<span class="s">  ]</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre></div></p>
<p>Register policy in AWS:
<div class="highlight"><pre><span></span><code>aws iot create-policy --policy-name lamassu-test-policy --policy-document file://templates/policy.json
</code></pre></div></p>
<p>Create the JITP template:
templates/jitp_template.json
<div class="highlight"><pre><span></span><code>tee templates/jitp_template.json <span class="s">&lt;&lt;EOF</span>
<span class="s">{</span>
<span class="s">&quot;templateBody&quot; : &quot;{ \&quot;Parameters\&quot; : { \&quot;AWS::IoT::Certificate::CommonName\&quot;: { \&quot;Type\&quot;: \&quot;String\&quot; }, \&quot;AWS::IoT::Certificate::SerialNumber\&quot;: {  \&quot;Type\&quot;: \&quot;String\&quot; }, \&quot;AWS::IoT::Certificate::Id\&quot;: { \&quot;Type\&quot;: \&quot;String\&quot; } }, \&quot;Resources\&quot;: { \&quot;thing\&quot;: { \&quot;Type\&quot;: \&quot;AWS::IoT::Thing\&quot;, \&quot;Properties\&quot;: { \&quot;ThingName\&quot;: {\&quot;Ref\&quot;: \&quot;AWS::IoT::Certificate::CommonName\&quot;  }, \&quot;AttributePayload\&quot;: {} }}, \&quot;certificate\&quot;: { \&quot;Type\&quot;: \&quot;AWS::IoT::Certificate\&quot;, \&quot;Properties\&quot;: { \&quot;CertificateId\&quot;: {\&quot;Ref\&quot;: \&quot;AWS::IoT::Certificate::Id\&quot; }, \&quot;Status\&quot;: \&quot;ACTIVE\&quot; }}, \&quot;policy\&quot;: { \&quot;Type\&quot;: \&quot;AWS::IoT::Policy\&quot;, \&quot;Properties\&quot;: { \&quot;PolicyName\&quot;: \&quot;lamassu-test-policy\&quot; } }}}&quot;,</span>
<span class="s">&quot;roleArn&quot;:&quot;arn:aws:iam::$aws_account:role/JITPRole&quot;</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre></div></p>
<blockquote>
<p><strong><em>NOTE</em></strong>: If policy name is changed it must be also changed in JITP template templateBody field.</p>
</blockquote>
<p>Update the CA certificate created in Step 1.</p>
<div class="highlight"><pre><span></span><code>aws iot update-ca-certificate --certificate-id <span class="nv">$certificate_id</span> --new-auto-registration-status ENABLE --registration-config file://templates/jitp_template.json
</code></pre></div>
<h3 id="step-4-issue-a-device-certificate-with-that-ca">Step 4: Issue a device certificate with that CA.</h3>
<hr />
<p>Generate device private key:
<div class="highlight"><pre><span></span><code>openssl genrsa -out test/certs/deviceCert.key <span class="m">2048</span> 
</code></pre></div></p>
<p>Generating CSR for device:
<div class="highlight"><pre><span></span><code>openssl req -new -key test/certs/deviceCert.key -out test/certs/deviceCert.csr -subj <span class="s2">&quot;/C=ES/ST=Gipuzkoa/L=Arrasate/O=testCAName/OU=Lamassu/CN=testdeviceLamassu&quot;</span>
</code></pre></div></p>
<p>Generating device certificate:
<div class="highlight"><pre><span></span><code>openssl x509 -req -in test/certs/deviceCert.csr -CA test/certs/deviceRootCA.pem -CAkey test/certs/deviceRootCA.key -CAcreateserial -out test/certs/deviceCert.crt -days <span class="m">365</span> -sha256 
</code></pre></div></p>
<p>Create certificate chain for the device:
<div class="highlight"><pre><span></span><code>cat test/certs/deviceCert.crt test/certs/deviceRootCA.pem &gt; test/certs/deviceCertAndCACert.crt
</code></pre></div></p>
<p>Downloading AWS Root CA certificate, it is needed to check IoT Core endpoint certificate:
<div class="highlight"><pre><span></span><code>wget https://www.amazontrust.com/repository/AmazonRootCA1.pem -O test/certs/awsRootCA.pem
</code></pre></div></p>
<h3 id="step-5-load-the-certificate-in-the-device">Step 5: Load the certificate in the device</h3>
<hr />
<p>If a test device is used, you need to the following files into it:
* test/certs/awsRootCA.
* test/certs/deviceCertAndCACert.crt
* test/certs/deviceCert.crt
* test/certs/deviceCert.key</p>
<h2 id="step-6-connect-to-the-iot-core-enpoint-using-that-certificate">Step 6: Connect to the IoT Core Enpoint using that certificate.</h2>
<hr />
<p>First, get the IoT Core Endpoint:
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">iot_endpoint</span><span class="o">=</span><span class="k">$(</span>aws iot describe-endpoint --endpoint-type iot:Data-ATS <span class="p">|</span> jq -r .endpointAddress<span class="k">)</span>
</code></pre></div>
Test connection to IoT Core:
 <code>bash
mosquitto_pub --cafile test/certs/awsRootCA.pem  \
              --cert test/certs/deviceCertAndCACert.crt \
              --key test/certs/deviceCert.key \
              -h $iot_endpoint \
              -p 8883 -q 1 \
              -t testdeviceLamassu -i testdeviceLamassu -m "hello JITP" -d</code></p>
<blockquote>
<p><strong><em>NOTE</em></strong>: Topic should start with device common name \<common name>/* and device ID (-i flag) should be equal to certificate common name.</p>
</blockquote>
<h2 id="references">References</h2>
<ul>
<li><strong><em>AWS JITP example</em></strong>: <a href="https://aws.amazon.com/es/blogs/iot/setting-up-just-in-time-provisioning-with-aws-iot-core/">JITP demo example</a></li>
<li><strong><em>JITP official documentation</em></strong>: <a href="https://docs.aws.amazon.com/iot/latest/developerguide/jit-provisioning.html">JITP documentation</a></li>
</ul>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../azure/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Azure Services used by Lamassu" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Azure Services used by Lamassu
            </div>
          </div>
        </a>
      
      
        
        <a href="../virtualDMS/" class="md-footer__link md-footer__link--next" aria-label="Next: Lamassu Virtual DMS" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Lamassu Virtual DMS
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/lamassuiot" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://hub.docker.com/u/lamassuiot" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/lamassuiot" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f758a944.min.js"></script>
      
    
  </body>
</html>